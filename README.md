# one-time-pass
gmailに送られてくる何らかのワンタイムパスコードを自動転送するwebアプリです。
ExpressフレームワークとGmailAPIを使っています。
あるサービスのアカウントを友人と共通でもつようになったことが、このアプリ製作のきっかけです。
基本的にワンタイムパスコードが送られてくるアドレスは一つしか選べず、既存のワンタイムパス認証は二人で使うには不便でした。
そこで、ワンタイムパスが送られてくるGmailからパスコードを抜き出し、即時転送することを考えました。
これはGmailの自動転送で簡単にできることが後からわかったのですが、気づくのが遅かった。
GmailAPIの公式ドキュメントを見ていて気付きました。

## index.js
`index.js`は、Google Cloud上のサーバでGmailAPIおよびPub/SubAPIからの通知を待ちます。
通知が来ると、ワンタイムパス判定アルゴリズムを起動して、指定した送信先（友人のemail）にパスコードを自動で送信します。

## oauth.js
`oauth.js`はGoogleAPIを使用するための認証をwebサーバ上で行います。
oauth2とはGoogleの個人用認証システムのことです。
GoogleAPIの中で使用したいものを指定し、使用するアカウントとともにGoogleに渡すと、認証用のURLを発行し認証画面に行くことができます。
そこで認証を終えると、Googleが、あらかじめ指定しておいたリダイレクト先（今回はGoogleCloudのlocalに設定しました）にcodeを持ったURLを発行してくれます。
そのURLが、GoogleAPIを使用するためのtokenの情報を持っており、`refresh token`という長期間使用可能な認証を得られるのです。

## watch.js
`watch.js`では、GmailAPIが、Pub/SubのTopicsにプッシュ通知を送れるよう設定しています。
Topicsとは、Pub/Subシステムにおける、情報のやり取りをする対象のようなもので、これを設定することで特定の情報を追えるようになります。
操作は極めてシンプルで、認証済みのgmailAPIがどのような通知をどのTopicsに送るかを指定するだけです。
今回はtopicsとして`gmail-notify`、通知の対象は`INBOX`としました。

## test_gmail.js
